<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Luxury Booking</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        /* ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
        :root { --primary: #00f260; --secondary: #0575E6; --dark-bg: #0f0c29; --glass: rgba(255, 255, 255, 0.05); --border: rgba(255, 255, 255, 0.1); --text: #ffffff; --text-muted: #a0a0a0; }
        body { font-family: 'Outfit', 'Kanit', sans-serif; margin: 0; padding: 0; background: linear-gradient(to right, #24243e, #302b63, #0f0c29); color: var(--text); min-height: 100vh; overflow-x: hidden; }
        .bg-circle { position: fixed; border-radius: 50%; filter: blur(80px); z-index: -1; animation: float 10s infinite ease-in-out; }
        .c1 { width: 300px; height: 300px; background: #0575E6; top: -50px; left: -50px; opacity: 0.4; }
        .c2 { width: 400px; height: 400px; background: #00f260; bottom: -100px; right: -100px; opacity: 0.2; animation-delay: 2s; }
        @keyframes float { 0% { transform: translate(0, 0); } 50% { transform: translate(20px, 30px); } 100% { transform: translate(0, 0); } }
        .container { max-width: 500px; margin: 20px auto; padding: 30px; background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .user-header { display: flex; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .user-avatar { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--primary); box-shadow: 0 0 15px rgba(0, 242, 96, 0.4); margin-right: 15px; object-fit: cover; }
        .welcome-text small { display: block; color: var(--text-muted); font-size: 0.9em; }
        .welcome-text strong { font-size: 1.2em; letter-spacing: 0.5px; }
        h2 { text-align: center; font-weight: 600; margin-bottom: 10px; background: linear-gradient(to right, #00f260, #0575E6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 1px; text-transform: uppercase;}
        
        /* Form & Inputs */
        .form-group { margin-bottom: 20px; position: relative; }
        label { font-size: 0.9em; color: var(--text-muted); margin-bottom: 8px; display: block; font-weight: 300; }
        .input-wrapper { position: relative; }
        .input-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); }
        input { width: 100%; padding: 15px 15px 15px 45px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 12px; color: white; font-family: 'Kanit', sans-serif; font-size: 16px; transition: all 0.3s; box-sizing: border-box; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 242, 96, 0.2); outline: none; background: rgba(0,0,0,0.5); }
        ::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.6; cursor: pointer; }
        
        /* Room Card (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) */
        .room-selector { display: flex; justify-content: center; padding-bottom: 10px; margin-bottom: 20px; }
        .room-card { width: 100%; max-width: 300px; background: rgba(255,255,255,0.03); border: 1px solid var(--primary); border-radius: 15px; padding: 15px; cursor: pointer; transition: all 0.3s; text-align: center; box-shadow: 0 0 20px rgba(0, 242, 96, 0.1); }
        .room-card img { width: 100%; height: 180px; object-fit: cover; border-radius: 10px; margin-bottom: 10px; }
        .room-card h4 { margin: 5px 0; font-size: 1.2em; font-weight: 600; }
        .room-card p { margin: 0; font-size: 1.1em; color: var(--primary); font-weight: bold; }
        
        /* Add-on Section */
        .addon-section { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .addon-info h4 { margin: 0; font-size: 1em; }
        .addon-info p { margin: 0; font-size: 0.8em; color: var(--primary); }
        .counter { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 30px; border: 1px solid var(--border); }
        .counter-btn { background: none; border: none; color: white; font-size: 1.2em; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.2s; }
        .counter-btn:hover { background: rgba(255,255,255,0.1); }
        #mookataQty { font-weight: bold; font-size: 1.1em; width: 20px; text-align: center; }

        /* Total Price */
        .total-bar { text-align: right; margin-bottom: 20px; font-size: 1.2em; border-top: 1px solid var(--border); padding-top: 15px; }
        .total-price { color: var(--primary); font-weight: bold; font-size: 1.4em; }

        .btn-submit { width: 100%; padding: 18px; background: linear-gradient(90deg, #00f260, #0575E6); border: none; border-radius: 50px; color: white; font-size: 18px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: all 0.3s; box-shadow: 0 10px 30px rgba(5, 117, 230, 0.4); }
        .btn-submit:disabled { background: #555; box-shadow: none; cursor: not-allowed; opacity: 0.7; }
    </style>
</head>
<body>

<div class="bg-circle c1"></div>
<div class="bg-circle c2"></div>

<div class="container animate__animated animate__fadeInUp">
    <div class="user-header">
        <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" id="userAvatar" class="user-avatar">
        <div class="welcome-text">
            <small>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö,</small>
            <strong id="displayName">Guest User</strong>
        </div>
    </div>

    <h2>BOOK YOUR STAY</h2>
    <p style="text-align:center; color: var(--text-muted); font-size:0.9em; margin-bottom:25px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>

    <label>‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</label>
    <div class="room-selector">
        <div class="room-card selected" onclick="selectRoom(this, 'Exclusive Villa', 5999)" data-img="https://images.unsplash.com/photo-1582719508461-905c673771fd?w=800">
            <img src="https://images.unsplash.com/photo-1582719508461-905c673771fd?w=400&q=80">
            <h4>Exclusive Villa</h4>
            <p>‡∏ø5,999 / ‡∏Ñ‡∏∑‡∏ô</p>
        </div>
    </div>
    
    <label style="margin-top:15px;">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°:</label>
    <div class="addon-section">
        <div class="addon-info">
            <h4>ü•© ‡∏ä‡∏∏‡∏î‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞</h4>
            <p>‡∏ä‡∏∏‡∏î‡∏•‡∏∞ ‡∏ø499</p>
        </div>
        <div class="counter">
            <button class="counter-btn" onclick="updateMookata(-1)">-</button>
            <span id="mookataQty">0</span>
            <button class="counter-btn" onclick="updateMookata(1)">+</button>
        </div>
    </div>

    <input type="hidden" id="selectedRoom" value="Exclusive Villa">
    <input type="hidden" id="selectedRoomPrice" value="5999">
    <input type="hidden" id="selectedRoomImg" value="https://images.unsplash.com/photo-1582719508461-905c673771fd?w=800">

    <div id="bookingForm">
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</label><div class="input-wrapper"><i class="fas fa-user input-icon"></i><input type="text" id="guestName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div></div>
        <div style="display:flex; gap:15px;">
            <div class="form-group" style="flex:1;"><label>‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</label><div class="input-wrapper"><input type="date" id="checkIn" style="padding-left:15px;"></div></div>
            <div class="form-group" style="flex:1;"><label>‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå</label><div class="input-wrapper"><input type="date" id="checkOut" style="padding-left:15px;"></div></div>
        </div>
        <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label><div class="input-wrapper"><i class="fas fa-phone input-icon"></i><input type="tel" id="phone" placeholder="08x-xxx-xxxx"></div></div>
        
        <div class="total-bar">
            ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <span id="totalPriceDisplay" class="total-price">‡∏ø5,999</span>
        </div>

        <button onclick="submitBooking()" id="submitBtn" class="btn-submit">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á <i class="fas fa-arrow-right"></i></button>
    </div>
</div>

<script>
    const LIFF_ID = "2008913218-CtwwqM6k"; 
    const SUPABASE_URL = "https://gaoukdnqgawneihdqomq.supabase.co"; 
    // ‡πÉ‡∏™‡πà Key ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏ú‡∏°‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏°‡∏≤)
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdhb3VrZG5xZ2F3bmVpaGRxb21xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTgwMDEsImV4cCI6MjA4Mzg5NDAwMX0.6w6gsCsFSztylN-Fbteiwd9ETGrJ65fHCQY6hlEAsdY"; 
    
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQhku7Toa6FHMhXj80rDJI0k0MrfQv5zNee2K9blzWeupxDWemNz9SnV3FcfqlzqrV/exec"; // ‡πÉ‡∏ä‡πâ URL ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let userProfile = null;
    let mookataCount = 0;

    async function main() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            userProfile = await liff.getProfile();
            if(userProfile.pictureUrl) document.getElementById("userAvatar").src = userProfile.pictureUrl;
            document.getElementById("displayName").innerText = userProfile.displayName;
            document.getElementById("guestName").value = userProfile.displayName;
        } catch (err) { console.error(err); }
    }
    main();

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏µ‡∏Å)
    function selectRoom(element, roomName, price) {
        document.querySelectorAll('.room-card').forEach(card => card.classList.remove('selected'));
        element.classList.add('selected');
        document.getElementById('selectedRoom').value = roomName;
        document.getElementById('selectedRoomPrice').value = price;
        document.getElementById('selectedRoomImg').value = element.getAttribute('data-img');
        calculateTotal();
    }

    function updateMookata(change) {
        mookataCount += change;
        if(mookataCount < 0) mookataCount = 0;
        document.getElementById('mookataQty').innerText = mookataCount;
        calculateTotal();
    }

    function calculateTotal() {
        const roomPrice = parseInt(document.getElementById('selectedRoomPrice').value);
        const mookataPrice = mookataCount * 499;
        const total = roomPrice + mookataPrice;
        document.getElementById('totalPriceDisplay').innerText = '‡∏ø' + total.toLocaleString();
        return total;
    }

    async function submitBooking() {
        const guestName = document.getElementById("guestName").value;
        const checkIn = document.getElementById("checkIn").value;
        const checkOut = document.getElementById("checkOut").value;
        const phone = document.getElementById("phone").value;
        const roomType = document.getElementById("selectedRoom").value;
        const roomImgUrl = document.getElementById('selectedRoomImg').value;
        const btn = document.getElementById("submitBtn");
        const totalPrice = calculateTotal();

        if(!guestName || !checkIn || !checkOut || !phone) {
            Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö', background: '#1a1a2e', color: '#fff', confirmButtonColor: '#f39c12' });
            return;
        }

        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
        btn.disabled = true;

        const bookingId = "BK-" + Math.floor(100000 + Math.random() * 900000);

        const { error } = await supabaseClient.from('bookings').insert([{ 
            user_id: userProfile ? userProfile.userId : 'web-user',
            display_name: guestName, check_in: checkIn, check_out: checkOut, phone: phone,
            booking_id: bookingId, room_type: roomType,
            mookata_qty: mookataCount, 
            total_price: totalPrice
        }]);

        if (error) {
            Swal.fire({ icon: 'error', title: 'Error', text: error.message });
            btn.innerHTML = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á <i class="fas fa-arrow-right"></i>';
            btn.disabled = false;
        } else {
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    bookingId: bookingId, userId: userProfile ? userProfile.userId : 'web-test', 
                    name: guestName, phone: phone, checkIn: checkIn, checkOut: checkOut, 
                    room: roomType, mookataQty: mookataCount, totalPrice: totalPrice 
                })
            }).catch(err => console.error("Notify Error", err));

            if (userProfile) {
                try {
                    let addonText = mookataCount > 0 ? `‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞ ${mookataCount} ‡∏ä‡∏∏‡∏î` : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°";
                    await liff.sendMessages([{
                        type: 'flex',
                        altText: '‡πÉ‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á ' + bookingId,
                        contents: {
                            "type": "bubble",
                            "hero": { "type": "image", "url": roomImgUrl, "size": "full", "aspectRatio": "20:13", "aspectMode": "cover" },
                            "body": {
                                "type": "box", "layout": "vertical", "paddingAll": "0px",
                                "contents": [
                                    {
                                        "type": "box", "layout": "vertical", "contents": [
                                            { "type": "text", "text": "BOOKING CONFIRMED", "weight": "bold", "color": "#FFFFFF", "size": "lg" },
                                            { "type": "text", "text": "ID: " + bookingId, "color": "#FFFFFFcc", "size": "sm", "margin": "sm" }
                                        ], "paddingAll": "lg", "background": { "type": "linearGradient", "angle": "90deg", "startColor": "#00f260", "endColor": "#0575E6" }
                                    },
                                    {
                                        "type": "box", "layout": "vertical", "paddingAll": "lg", "spacing": "md",
                                        "contents": [
                                            { "type": "text", "text": roomType, "weight": "bold", "size": "xl", "color": "#333333" },
                                            { "type": "separator" },
                                            { "type": "box", "layout": "vertical", "spacing": "sm", "contents": [
                                                { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:", "color": "#aaaaaa", "size": "sm", "flex": 2 }, { "type": "text", "text": guestName, "color": "#333333", "size": "sm", "flex": 4 }] },
                                                { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:", "color": "#aaaaaa", "size": "sm", "flex": 2 }, { "type": "text", "text": `${checkIn} - ${checkOut}`, "color": "#333333", "size": "sm", "flex": 4 }] },
                                                { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°:", "color": "#aaaaaa", "size": "sm", "flex": 2 }, { "type": "text", "text": addonText, "color": "#333333", "size": "sm", "flex": 4 }] }
                                            ]},
                                            { "type": "separator" },
                                            { "type": "box", "layout": "baseline", "contents": [
                                                { "type": "text", "text": "‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥", "weight": "bold", "size": "md", "flex": 1, "color": "#333333" },
                                                { "type": "text", "text": "‡∏ø" + totalPrice.toLocaleString(), "weight": "bold", "size": "xl", "align": "end", "color": "#00f260", "flex": 1 }
                                            ]}
                                        ]
                                    }
                                ]
                            }
                        }
                    }]);
                } catch (err) { console.error("LIFF Send Error", err); }
            }

            Swal.fire({
                icon: 'success', title: '‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', html: `‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: <b style="color:#00f260;">${bookingId}</b><br>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <b>‡∏ø${totalPrice.toLocaleString()}</b>`, background: '#1a1a2e', color: '#fff', timer: 3000, showConfirmButton: false
            }).then(() => { liff.closeWindow(); });
        }
    }
</script>
</body>
</html>